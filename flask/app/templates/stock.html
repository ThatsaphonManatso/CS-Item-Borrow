{% extends "base.html" %}
{% block content %}


<div class="container is-centered con-margin">

  <div class="columns is-centered rows">
    
      <div class="container is-centered con-margin">
        <div class="row">
          <!-- <div class="column is-centered is-flex is-justify-content-center">
            <button class="button show-stock" data-target="modal-js-example">+</button>
          </div> -->
          <div class="custom-column">
            <button class="button show-stock" data-target="modal-js-example">+</button>
          </div>
          {% for item in each_items %}
            <div class="custom-column" id="each-item" data-id="{{ item.id }}">
              <div class="edit-stock " style="display: block;">
                <div class="columns is-centered is-flex is-justify-content-center">
                  <img class="show-img" src="{{ item.url_img }}">
                </div>

                <div class="columns status-item-show">
                  <span class="status-item">Available : {{ item.count_avail }}</span>
                </div>
                <div class="columns status-item-show">
                  <span class="status-item">Unavailable : {{ item.count_unava }}</span>
                </div>
                <div class="columns status-item-show">
                  <span class="status-item">Repairing : {{ item.count_rep }}</span>
                </div>
                
                <div class="columns" style="display: flex;">
                  <div class="column is-centered is-flex is-justify-content-center">
                    <button class="edit-butt d-butt butt-row" data-id="1">
                        <img src="static/ico/del_button.png" alt="Delete" class="del-icon">
                    </button>
                  </div>
                  
                  <div class="column is-centered is-flex is-justify-content-center">
                    <button class="edit-butt e-butt butt-row" data-target="item-edit">
                      <img src="static/ico/edit_button.png" alt="Edit" class="edit-icon">
                    </button>
                  </div>

                </div>  
              </div> 
            </div>
          {% endfor %}

        </div>
      </div>
    

    

  </div>
  

</div>  

<div id="item-edit" class="modal">
  <div class="modal-background"></div>
  
    <div class="modal-content" style="display: block; width: 800px; height: 400px;">  
  
      <div class="columns is-justify-content-center" style="padding-bottom: 10px;">
        <div class="column is-centered" background-color: #fbfbfb>
          <div class="column is-centered is-flex is-justify-content-center">
            <input type="file" id="fileInput2" accept="image/*" style="display: none;">
            <img id="preview2" src="static/img/microphone.png">
          </div>
          <div class="columns is-centered is-flex is-justify-content-center"  style="margin-top: 10px;">
            <button class="button" onclick="document.getElementById('fileInput2').click()">change</button>
          </div>
        </div>

      <div class="column" style="margin-top: 30px;padding-right: 50px;">
        <form action="/stock/edit" method="POST"> 
          {{ form.hidden_tag() }}
          <div class="field">
            <label for="item_name" class="label">Name :</label>
              <div class="control">
                <input type="text" class="input" id="item_name_edit" name="item_name" required>
              </div>
          </div>
          
            <div class="field">
              <label for="item_status" class="label">Available for :</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="item_status_edit" name="item_status" required>
                      <option value="" disabled selected>Choose...</option>
                      <option value="Teacher">Teacher</option>
                      <option value="Student">Student</option>
                      <option value="Both">Both</option>
                    </select>
                  </div>
                </div>
            </div>
          
          <div class="field">
            <label for="item_quantity" class="label">Amount for stock :</label>
              <div class="control">
                <input type="number" class="input" id="item_quantity_edit" name="item_quantity" min="1" required>
              </div>
          </div>
          
          <div class="field is-grouped is-grouped-centered mt-4">
            <button type="button" class="button" id="add-bt">Add </button>
            <button type="button" class="button cancel-bt" id="cancel-bt">Cancel</button>
          </div>
          
        </form>
      </div>

    </div>
    </div>
  </div>   
</div> <!--end of columns-->

<div id="modal-js-example" class="modal">
  <div class="modal-background" style="padding-top: 100px;">
    <form id="stock-form" action="/stock/add" method="POST"> 
      {{ form.hidden_tag() }}
      <div class="modal-content" >        
        <div class="column is-centered is-flex is-justify-content-center" style="display: block;">
          <div class="field">
            <input type="file" id="fileInput1" accept="image/*" name="file" style="display: none;">
              <img class="ico" id="preview1" src="static/ico/camera.png">
          </div>      
        </div>

        <div class="columns is-justify-content-center">
          <button class="button add-img-butt" type="button" onclick="document.getElementById('fileInput1').click()">Add Image</button>
        </div>

        <div class="column" background-color: #fbfbfb>
        
          <div class="field">
            <label for="item_name" class="label">Name :</label>
              <div class="control">
                <input type="text" class="input" id="item_name_add" name="item_name" required>
              </div>
          </div>

          <div class="field">
            <label for="item_description" class="label">Description :</label>
              <div class="control">
                <input type="text" class="input" id="item_description_add" name="item_description" value="">
              </div>
          </div>
          
          <div class="columns">
            <div class="column is-half">
              <div class="field">
                <label for="item_status" class="label">Available for :</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="item_status_add" name="item_status" required>
                      <option value="" disabled selected>Choose...</option>
                      <option value="Teacher">Teacher</option>
                      <option value="Student">Student</option>
                      <option value="Both">Both</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          
            <div class="column is-half">
              <div class="field">
                <label for="item_quantity" class="label">Amount for stock :</label>
                <div class="control">
                  <input type="number" class="input" id="item_quantity_add" name="item_quantity" min="1" required>
                </div>
              </div>
            </div>
          </div>
          
          <div class="field is-grouped is-grouped-centered mt-4">
            <button type="button" class="button"  id="add-bt">Add</button>
            <button type="button" class="button cancel-bt" id="cancel-bt">Cancel</button>
          </div>    

        
        </div>
      </div>
    </form>
  </div>
</div>

</div> 

<script>
document.addEventListener('DOMContentLoaded', () => {
  function openModal($el) {
    $el.classList.add('is-active');
  }

  function closeModal($el) {
    $el.classList.remove('is-active');
  }

  function closeAllModals() {
    document.querySelectorAll('.modal').forEach(($modal) => {
      closeModal($modal);
    });
  }

  document.querySelectorAll('.select select').forEach(($select) => {
  $select.addEventListener('click', (event) => {
    event.stopPropagation();
  });
});


  document.querySelectorAll('.ico ico').forEach(($ico) => {
  $select.addEventListener('click', (event) => {
    event.stopPropagation();
  });
  });



  document.querySelectorAll('.show-stock').forEach(($trigger) => {
    const modal = $trigger.dataset.target;
    const $target = document.getElementById(modal);

    $trigger.addEventListener('click', () => {
      openModal($target);
    });
  });

  document.querySelectorAll('.modal-close, #cancel-bt').forEach(($close) => {
    const $target = $close.closest('.modal');

    $close.addEventListener('click', () => {
      closeModal($target);
    });
  });

  document.addEventListener('keydown', (event) => {
    if(event.key === "Escape") {
      closeAllModals();
    }
  });


  document.querySelectorAll('.e-butt').forEach(($trigger) => {
    const modal = $trigger.dataset.target;
    const $target = document.getElementById(modal);

    $trigger.addEventListener('click', () => {
      openModal($target);
    });
  });




    document.getElementById('fileInput1').addEventListener('change', function(event) {
              const file = event.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      const img = document.getElementById('preview1');
                      img.src = e.target.result;
                      img.style.display = 'flex';
                  };
                  reader.readAsDataURL(file);
              }
          }); 

          document.getElementById('fileInput2').addEventListener('change', function(event) {
              const file = event.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      const img = document.getElementById('preview2');
                      img.src = e.target.result;
                      img.style.display = 'flex';
                  };
                  reader.readAsDataURL(file);
              }
          }); 
});

      document.addEventListener("DOMContentLoaded", () => {
          $(document).on("click", "#add-bt", function (event) {
              event.preventDefault();

              // Get form values
              let itemName = document.getElementById("item_name_add").value.trim();
              let itemStatus = document.getElementById("item_status_add").value;
              let itemQuantity = document.getElementById("item_quantity_add").value.trim();
              let fileInput = document.getElementById("fileInput1");
              let file = fileInput.files[0];

              // Validate Name
              if (!itemName) {
                  Swal.fire("Error!", "Name is required!", "error");
                  return;
              }

              // Validate Status
              if (!itemStatus) {
                  Swal.fire("Error!", "You must select a status!", "error");
                  return;
              }

              // Validate Quantity
              if (!itemQuantity || isNaN(itemQuantity) || parseInt(itemQuantity) <= 0) {
                  Swal.fire("Error!", "Amount for stock must be greater than 0!", "error");
                  return;
              }

              // Validate Image (if image is required)
              if (!file) {
                  Swal.fire("Error!", "You must upload an image!", "error");
                  return;
              }

              // Validate file type and size
              const validImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
              const maxSize = 2 * 1024 * 1024; // 2MB

              if (!validImageTypes.includes(file.type)) {
                  Swal.fire("Error!", "Please upload a valid image file (JPG, PNG, GIF only).", "error");
                  fileInput.value = '';  // Reset the file input
                  return;
              }

              if (file.size > maxSize) {
                  Swal.fire("Error!", "File size exceeds the maximum limit of 2MB.", "error");
                  fileInput.value = '';  // Reset the file input
                  return;
              }

              // If everything is valid, show confirmation
              Swal.fire({
                  title: "Do you want to add?",
                  text: "You are adding items.",
                  icon: "question",
                  confirmButtonText: "Confirm",
                  cancelButtonText: "Cancel",
                  showCancelButton: true
              }).then((result) => {
                  if (result.isConfirmed) {
                      // Prepare form data for submission
                      var formData = {}; 
                      $("#stock-form").serializeArray().forEach(function (field) {
                          formData[field.name] = field.value;
                      });

                      // Send form data via POST
                      $.post($("#stock-form").attr("action"), formData, function (response) {
                          if (response.success) {
                              Swal.fire("Success!", response.message, "success").then(() => {
                                  clearForm();
                                  location.reload();
                              });
                          } else {
                              Swal.fire("Error!", response.message, "error");
                          }
                      }).fail(function (xhr) {
                          Swal.fire("Error!", "Server error: " + xhr.status + " " + xhr.statusText, "error");
                      });
                  }
              });
          });
      });

function clearForm() {
    $("#stock-form")[0].reset();
}


$(document).on("click", ".d-butt", function(event) {
    event.preventDefault();
    let $row = $(this).closest("#each-item");  
    let itemId = $(this).data("id");  

    Swal.fire({
              title: "Do you want to delete?",
              text: "You are deleting this item",
              icon: "warning",
              confirmButtonText: "Delete",
              cancelButtonText: "Cancel",
              showCancelButton: true
          }).then((result) => {
              if (result.isConfirmed) {
                $.ajax({
                url: "/delete_item", 
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ "id": itemId }),
                success: function(response) {
                    if (response.success) {
                        Swal.fire("Deleted!", response.message, "success");
                        $row.fadeOut(300, function() { $(this).remove(); }); 
                    } else {
                        Swal.fire("Error!", response.message, "error");
                    }
                },
                error: function(xhr) {
                    Swal.fire("Error!", "Server error: " + xhr.status + " " + xhr.statusText, "error");
                }
            });
        }
    });
  });

</script>
<link rel="stylesheet" href="static/css/stock.css">
{% endblock %}
